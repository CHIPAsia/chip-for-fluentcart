name: WordPress Plugin Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  plugin-check:
    name: Plugin Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare plugin directory (exclude hidden files)
        run: |
          mkdir -p ./build/chip-for-fluent-cart
          # Copy only non-hidden files and directories
          rsync -av --exclude='.*' --exclude='build' ./ ./build/chip-for-fluent-cart/
          ls -la ./build/chip-for-fluent-cart/

      - name: Run Plugin Check
        uses: wordpress/plugin-check-action@v1
        with:
          build-dir: './build/chip-for-fluent-cart'
          exclude-directories: 'vendor,node_modules'

  phpcs:
    name: PHP CodeSniffer (WordPress Standards)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'

      - name: Install WordPress Coding Standards
        run: |
          composer global config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer global require --dev squizlabs/php_codesniffer dealerdirect/phpcodesniffer-composer-installer wp-coding-standards/wpcs:"^3.0"
          echo "$(composer global config bin-dir --absolute)" >> $GITHUB_PATH

      - name: Verify PHPCS Standards
        run: |
          phpcs -i

      - name: Run PHPCS
        run: |
          phpcs --standard=WordPress --extensions=php --ignore=vendor,node_modules .
        continue-on-error: false

  php-compatibility:
    name: PHP ${{ matrix.php-version }} Compatibility
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.4']
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP ${{ matrix.php-version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}

      - name: Install PHPCompatibility
        run: |
          composer global config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer global require --dev squizlabs/php_codesniffer dealerdirect/phpcodesniffer-composer-installer phpcompatibility/phpcompatibility-wp:"*"
          echo "$(composer global config bin-dir --absolute)" >> $GITHUB_PATH

      - name: Verify PHPCS Standards
        run: |
          phpcs -i

      - name: Check PHP ${{ matrix.php-version }} Compatibility
        run: |
          phpcs --standard=PHPCompatibilityWP --runtime-set testVersion ${{ matrix.php-version }} --extensions=php --ignore=vendor,node_modules .

